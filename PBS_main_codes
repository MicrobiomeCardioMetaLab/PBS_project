#### Main codes for CGVR project 
# 1. taxonomy abundance profile
# 2. functional pathways profile
# 3. association_analysis
# 4. mediation analysis

### step_1 taxonomy abundance profile
metaphlan --bowtie2db ${METAPHLAN_DATABASE}  ${result_dir}/kneaddata/pair_reads/${sample}_paired_1.fastq.gz,${result_dir}/kneaddata/pair_reads/${sample}_paired_2.fastq.gz --index mpa_v202403_GMR --input_type fastq --nproc ${threads} --output_file ${result_dir}/metaphlan/single_sample/${sample}.profile -s ${result_dir}/metaphlan/single_sample/${sample}.sam.bz2 --bowtie2out ${result_dir}/metaphlan/single_sample/${sample}.bowtie2_out.bz2  --unclassified_estimation 2> ${LOG_DIR}/metaphlan/${sample}.log 

### step_2 functional pathways profile
mkdir -p ${LOG_DIR}/humann
mkdir -p ${result_dir}/humann/${sample}
time humann -i ${result_dir}/kneaddata/pair_reads/${sample}_paired_1.fastq.gz \
      -i ${result_dir}/kneaddata/pair_reads/${sample}_paired_2.fastq.gz \
      --taxonomic-profile ${result_dir}/metaphlan/single_sample/${sample}.profile \
      --threads ${threads} \
      --output ${result_dir}/humann/${sample}/ \
      2> ${LOG_DIR}/humann/${sample}.log

### step_3 Association between species abundance and microbial features and phenotypes
raw_phenotype <- read.csv("197phenotypes.csv", row.names = 1)
data <- read.csv("197species_abundance.csv", row.names = 1)
phenotype_columns <- colnames(raw_phenotype)[!colnames(raw_phenotype) %in% c("sample_ID")]
microbe_columns <- colnames(data)[!colnames(data) %in% c("sample_ID")]
all_p_values <- data.frame(Phenotype = character(), Microbe = character(), P_value = numeric(), stringsAsFactors = FALSE)
analyze_ass <- function(pheno_df, micro_df, phenotype, microbe, output_dir) {
  merged_data <- merge(pheno_df, micro_df, by = "row.names", all = TRUE)
  rownames(merged_data) <- merged_data$Row.names
  merged_data$Row.names <- NULL
  valid_data <- merged_data[complete.cases(merged_data[, c(phenotype, microbe)]), c(phenotype, microbe)]
  valid_data <- valid_data[is.finite(valid_data[[microbe]]), ]
  correlation_test <- cor.test(valid_data[[phenotype]], valid_data[[microbe]], method = "spearman")
  lm_model <- lm(as.formula(paste(microbe, "~", phenotype)), data = valid_data)
  beta_coefficient <- coef(lm_model)[2]
  p_value <- correlation_test$p.value
  correlation_coefficient <- correlation_test$estimate
  global_p_values <- get("all_p_values", envir = .GlobalEnv)
  global_p_values <- rbind(global_p_values, data.frame(Phenotype = phenotype, Microbe = microbe, P_value = p_value, Correlation = correlation_coefficient, Beta = beta_coefficient, stringsAsFactors = FALSE))
  assign("all_p_values", global_p_values, envir = .GlobalEnv)
}
for (phenotype in phenotype_columns) {
  phenotype_output_dir <- file.path("clr_corr_phenotype_2", phenotype)
  if (!dir.exists(phenotype_output_dir)) {
    dir.create(phenotype_output_dir, recursive = TRUE)
  }
  for (microbe in microbe_columns) {
    analyze_ass(raw_phenotype, data, phenotype, microbe, phenotype_output_dir)
  }    
}
global_p_values <- get("all_p_values", envir = .GlobalEnv)
global_p_values$Adjusted_P_value <- p.adjust(global_p_values$P_value, method = "BH")
write.csv(global_p_values, file = "all_adj_p_values.csv", row.names = FALSE)

### step_4 mediation analysis: microbial impacts on phenotypes through metabolites
all=cbind(pheno,microbe,diet)
ass=read.delim("ass_path_pheno.txt",header = T,sep = "\t")
ass=ass[which(ass$Pval<0.05),]
colnames(ass)[3:4]=paste("di_pheno",colnames(ass)[3:4],sep = "_")
tmp=read.delim("ass_path_meta.txt",header = T,sep = "\t")
tmp=tmp[which(tmp$Pval<0.05),]
colnames(tmp)[3:4]=paste("di_microbe",colnames(tmp)[3:4],sep = "_")
tmp1=read.delim("ass_meta_pheno.txt",header = T,sep = "\t")
tmp1=tmp1[which(tmp1$Pval<0.05),]
colnames(tmp1)[3:5]=paste("pheno_path",colnames(tmp1)[3:5],sep = "_")
tmp1$name=paste(tmp1$path,ass$pheno,sep = "_with_")
ass=merge(ass[,1:4],tmp[,1:4],by="di",all = F)
ass$name=paste(ass$microbe,ass$pheno,sep = "_with_")
ass=merge(ass,tmp1[,3:6],by="name",all = F)
ass=ass[,c(2,3,6,4:5,7:11)]
##mediation
ass$Pval_mediate=NA
ass$Pval_direct=NA
ass$med_prop=NA
ass$Pval_mediate_inverse=NA
ass$Pval_direct_inverse=NA
library(mediation)
for(i in 1:nrow(ass)){
  data=all[,c(as.character(ass$di[i]),as.character(ass$pheno[i]),as.character(ass$microbe[i]))]
  data=na.omit(data)
  colnames(data)=c("X","Y","M")
  #MetaCyc pathway influence temperament through metabolites
    model.m=lm(M~X,data)
    model.y=lm(Y~X+M,data)
    summary=summary(mediate(model.m ,model.y,treat = "X", mediator = "M",boot = T,sims = 1000))
    ass$Pval_mediate[i]=summary$d.avg.p
    ass$Pval_direct[i]=summary$z.avg.p
    ass$med_prop[i]=summary$n0
  #inverse mediate
  colnames(data)=c("Y","X","M")
  model.m=lm(M~X,data)
  model.y=lm(Y~X+M,data)
  summary=summary(mediate(model.m ,model.y,treat = "X", mediator = "M",boot = T,sims = 1000))
  ass$Pval_mediate_inverse[i]=summary$d.avg.p
  ass$Pval_direct_inverse[i]=summary$z.avg.p
}

